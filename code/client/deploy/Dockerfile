# build-stage: compile the client in the dist directory using vue-cli-service
FROM node:16.20-bullseye-slim AS build-stage

RUN mkdir -p /app/client
COPY .. /app/client
WORKDIR /app/client

# Installing git and exiftool package to remove EXIF data from pictures
RUN apt update && apt -y install git exiftool

RUN npm install
RUN npm run build

# removing pictures' EXIF data
RUN find ./dist -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.gif" \) -exec exiftool -overwrite_original -All= '{}' +

# production-stage: copies the content generated by the previous stage and makes it public through nginx
FROM nginx:1.25.0-alpine as production-stage
COPY --from=build-stage /app/client/dist /usr/share/nginx/html
COPY --from=build-stage /app/client/deploy/default.conf /etc/nginx/conf.d/
CMD ["nginx", "-g", "daemon off;"]
